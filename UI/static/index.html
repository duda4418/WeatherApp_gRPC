<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1115;
      --panel: #1b1f25;
      --text: #e6e9ef;
      --accent: #4dabf7;
      --danger: #ff6b6b;
      --ok: #51cf66;
      --border: #2a2f37;
      --muted: #8a93a0;
    }
    [data-theme="light"] {
      --bg: #f6f8fb; --panel:#ffffff; --text:#222; --accent:#1976d2; --danger:#d32f2f; --ok:#2e7d32; --border:#d7dce4; --muted:#606c76;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background: radial-gradient(circle at 20% 20%, #12141a, #0d0f13 55%); color: var(--text); }
    header { padding:1rem 1.25rem; display:flex; align-items:center; gap:1rem; justify-content:space-between; border-bottom:1px solid var(--border); backdrop-filter: blur(6px); position:sticky; top:0; background:linear-gradient(to right, rgba(15,17,21,.9),rgba(15,17,21,.75)); }
    h1 { font-size:1.1rem; margin:0; letter-spacing:.5px; font-weight:600; }
    main { padding:1.2rem; max-width:1200px; margin:0 auto; display:grid; gap:1.2rem; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:1rem 1.1rem; box-shadow:0 4px 12px -2px rgba(0,0,0,.4); position:relative; overflow:hidden; }
    .panel h2 { margin:.1rem 0 .75rem; font-size:.95rem; letter-spacing:.5px; text-transform:uppercase; font-weight:600; color:var(--muted); }
    label { font-size:.75rem; text-transform:uppercase; letter-spacing:.5px; display:flex; flex-direction:column; gap:.35rem; font-weight:600; color:var(--muted); }
    input[type=text], input[type=number] { background:var(--bg); border:1px solid var(--border); color:var(--text); padding:.55rem .7rem; border-radius:8px; font-size:.85rem; }
    input:focus { outline:2px solid var(--accent); outline-offset:2px; }
    button { background:var(--accent); color:#fff; border:none; padding:.7rem 1rem; font-weight:600; letter-spacing:.5px; border-radius:8px; cursor:pointer; font-size:.8rem; display:inline-flex; align-items:center; gap:.4rem; box-shadow:0 2px 6px -1px rgba(0,0,0,.5); }
    button:hover { filter:brightness(1.1); }
    button:active { transform:translateY(1px); }
    .grid { display:grid; gap:.75rem; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); }
    .kv { background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:.55rem .6rem; text-align:center; }
    .kv .v { font-size:1rem; font-weight:600; }
    .kv .k { font-size:.65rem; text-transform:uppercase; color:var(--muted); letter-spacing:.5px; }
    #chartWrap { min-height:340px; display:flex; align-items:center; }
    #status { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.7rem; white-space:pre-wrap; margin:0; padding:.6rem .7rem; background:var(--bg); border:1px solid var(--border); border-radius:10px; max-height:160px; overflow:auto; }
    .row { display:flex; flex-wrap:wrap; gap:.75rem; align-items:flex-end; }
    .grow { flex:1; }
    .muted { color:var(--muted); font-size:.7rem; }
    .switch { cursor:pointer; font-size:.7rem; padding:.4rem .6rem; border-radius:8px; border:1px solid var(--border); background:var(--panel); }
    .auto-refresh { display:flex; align-items:center; gap:.4rem; font-size:.7rem; }
    footer { text-align:center; padding:1.2rem .8rem 2.4rem; font-size:.65rem; color:var(--muted); }
    a { color:var(--accent); text-decoration:none; }
    a:hover { text-decoration:underline; }
    @media (max-width:680px){ header { flex-direction:column; align-items:flex-start; gap:.6rem;} main { padding:.9rem; } }
  </style>
</head>
<body>
  <header>
    <h1>Weather Dashboard</h1>
    <div style="display:flex; gap:.6rem; align-items:center;">
      <div class="auto-refresh">
        <label style="display:flex; flex-direction:row; gap:.4rem; align-items:center; font-weight:500; text-transform:none;">
          <input type="checkbox" id="auto" /> Auto-refresh
        </label>
        <input type="number" id="interval" value="60" min="10" max="3600" style="width:80px" />
        <span class="muted">sec</span>
      </div>
      <button id="toggleTheme" class="switch" type="button">Light/Dark</button>
    </div>
  </header>

  <main>
    <!-- Controls -->
    <section class="panel" style="grid-column: span 1;">
      <h2>Query</h2>
      <div class="row">
        <label class="grow">City
          <input id="city" type="text" value="London" />
        </label>
        <label>Window (min)
          <input id="minutes" type="number" value="120" min="5" max="1440" />
        </label>
        <label>Bucket (min)
          <input id="bucket" type="number" value="5" min="1" max="120" />
        </label>
        <label id="daysWrap" style="display:none;">Days
          <input id="days" type="number" value="7" min="1" max="60" />
        </label>
      </div>
      <div class="row" style="margin-top:.8rem; gap:.6rem;">
        <button id="load" type="button">Load Series</button>
        <button id="export" type="button" style="background:var(--ok)">Export CSV</button>
        <span class="muted" id="summary"></span>
      </div>
      <div class="row" style="margin-top:.6rem;">
        <div style="display:flex; gap:.5rem; font-size:.7rem;">
          <label style="flex:1; flex-direction:row; align-items:center; gap:.35rem;"> <input type="radio" name="view" value="hourly" checked /> Hourly </label>
          <label style="flex:1; flex-direction:row; align-items:center; gap:.35rem;"> <input type="radio" name="view" value="daily" /> Daily </label>
        </div>
      </div>
    </section>

    <!-- Current conditions enriched -->
    <section class="panel" style="grid-column: span 1;">
      <h2>Current Conditions</h2>
      <div style="display:flex; gap:1rem; align-items:center;">
        <img id="icon" alt="icon" style="width:72px;height:72px; filter:drop-shadow(0 2px 6px rgba(0,0,0,.5));" />
        <div style="flex:1;">
          <div id="currentSummary" style="font-size:.85rem; line-height:1.3"></div>
        </div>
      </div>
      <div id="metrics" class="grid" style="margin-top:.75rem"></div>
    </section>

    <!-- Chart -->
    <section class="panel" style="grid-column: span 2; min-height:360px;">
      <h2>Temperature Chart</h2>
      <div id="chartWrap">
        <canvas id="chart" height="320"></canvas>
      </div>
    </section>

    <!-- Additional details -->
    <section class="panel" style="grid-column: span 2;">
      <h2>Details</h2>
      <div id="details" class="grid"></div>
    </section>

    <!-- Log / status -->
    <section class="panel" style="grid-column: span 2;">
      <h2>Status</h2>
      <pre id="status">Ready.</pre>
    </section>
  </main>

  <footer>
    Data aggregated from stored observations. Latest metrics from most recent document.
  </footer>

  <script>
    const q = (sel)=>document.querySelector(sel);
    const statusEl = q('#status');
    const metricsEl = q('#metrics');
    const detailsEl = q('#details');
    const iconEl = q('#icon');
    const currentSummaryEl = q('#currentSummary');
    const summaryEl = q('#summary');
    let chart;
    let autoTimer;

    function log(msg){
      const ts = new Date().toISOString();
      statusEl.textContent = `[${ts}] ${msg}\n` + statusEl.textContent.slice(0, 4000);
    }

    function renderBucketLatest(point){
      // Called for series latest fallback when current endpoint not used
      if(!point){ return; }
      currentSummaryEl.innerHTML = `Bucket Latest Temp <strong>${point.avg_temp_c?.toFixed(2)}Â°C</strong> @ ${new Date(point.timestamp).toLocaleTimeString()}`;
    }
    // Backwards alias for older references
    const renderLatest = renderBucketLatest;

    function renderCurrent(data){
      if(!data){
        currentSummaryEl.innerHTML = '<span class="muted">No current observation.</span>';
        metricsEl.innerHTML = '';
        detailsEl.innerHTML = '';
        iconEl.src='';
        return;
      }
      const w = data.weather || {};
      iconEl.src = w.icon_url || '';
      const desc = [w.main, w.description].filter(Boolean).join(' â€¢ ');
      currentSummaryEl.innerHTML = `<strong>${data.city}</strong><br>${desc || 'N/A'}<br><span class="muted">Observed ${new Date(data.observation_time_iso || data.source_timestamp_iso).toLocaleString()}</span>`;
      const t = data.temperature || {};
      const sun = data.sun || {};
      const pressure = data.pressure || {};
      const wind = data.wind || {};
      const blocks = [
        ['Temp', t.temp_c, 'Â°C'],
        ['Feels', t.feels_like_c, 'Â°C'],
        ['Min', t.min_c, 'Â°C'],
        ['Max', t.max_c, 'Â°C'],
        ['Humid', data.humidity_pct, '%'],
        ['Pressure', pressure.hpa, 'hPa'],
        ['SeaLvl', pressure.sea_level_hpa, 'hPa'],
        ['Ground', pressure.ground_level_hpa, 'hPa'],
        ['Wind', wind.speed_ms, 'm/s'],
        ['Clouds', data.cloud_coverage_pct, '%'],
        ['Visib', data.visibility_m, 'm'],
      ];
      metricsEl.innerHTML = blocks.map(([k,v,u])=>`<div class="kv"><div class="v">${v===undefined||v===null?'â€“':v}</div><div class="k">${k}${u?'' : ''}</div></div>`).join('');
      const deg = wind.deg;
      const arrow = deg!==undefined && deg!==null ? `<div style='transform:rotate(${deg}deg);'>ðŸ¡±</div>` : 'â€“';
      detailsEl.innerHTML = `
        <div class="kv"><div class="v">${data.country||'â€“'}</div><div class="k">Country</div></div>
        <div class="kv"><div class="v">${data.coords?.lat ?? 'â€“'}, ${data.coords?.lon ?? 'â€“'}</div><div class="k">Coords</div></div>
        <div class="kv"><div class="v">${sun.sunrise_iso? new Date(sun.sunrise_iso).toLocaleTimeString(): 'â€“'}</div><div class="k">Sunrise</div></div>
        <div class="kv"><div class="v">${sun.sunset_iso? new Date(sun.sunset_iso).toLocaleTimeString(): 'â€“'}</div><div class="k">Sunset</div></div>
        <div class="kv"><div class="v">${arrow}</div><div class="k">Wind Dir</div></div>
      `;
    }

    function toCsv(data){
      const header = 'timestamp,avg_temp_c';
      const rows = data.points.map(p=>`${p.timestamp},${p.avg_temp_c}`);
      return [header, ...rows].join('\n');
    }

    function downloadCsv(name, content){
      const blob = new Blob([content], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }

    function currentView(){
      return document.querySelector('input[name="view"]:checked').value;
    }

    async function load(){
      const city = q('#city').value.trim();
      log('Loadingâ€¦');
      try {
        let data;
        if(currentView()==='daily'){
          const days = q('#days').value;
          const resp = await fetch(`/api/daily?city=${encodeURIComponent(city)}&days=${days}`);
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          data = await resp.json();
          if(!Array.isArray(data.points) || !data.points.length){
            renderBucketLatest(null); summaryEl.textContent='No daily points'; log('No daily data.'); if(chart) chart.destroy(); return;
          }
          const labels = data.points.map(p=>p.date);
          const temps = data.points.map(p=>p.avg_temp_c);
          const dailyIcons = data.points.map(p=>p.icon_url);
          const dailyIconImages = dailyIcons.map(src=>{ if(!src) return null; const img = new Image(); img.src = src; return img; });
          if(chart) chart.destroy();
          chart = new Chart(q('#chart'), {
            type:'line',
            data:{
              labels,
              datasets:[{
                label:`${data.city} Daily Avg Â°C`,
                data:temps,
                borderColor:'var(--accent)',
                backgroundColor:'rgba(77,171,247,.15)',
                pointRadius:6,
                pointHoverRadius:8,
                tension:.25,
                fill:true,
                pointStyle:(ctx)=> dailyIconImages[ctx.dataIndex] || 'circle'
              }]
            },
            options:{
              responsive:true,
              maintainAspectRatio:false,
              interaction:{ mode:'nearest', intersect:false },
              plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(ctx)=>`${ctx.parsed.y.toFixed(2)} Â°C` } } },
              scales:{ y:{ title:{ display:true, text:'Avg Temp (Â°C)' }, grid:{ color:'rgba(255,255,255,.06)' } }, x:{ grid:{ display:false } } }
            }
          });
          // Latest = last day
          renderBucketLatest({ timestamp: labels[labels.length-1], avg_temp_c: temps[temps.length-1] });
          summaryEl.textContent = `${data.points.length} days â€¢ window ${data.window_days}d`;
          log('Loaded daily series.');
          return;
        }
        // Hourly path
        const minutes = q('#minutes').value;
        const bucket = q('#bucket').value;
        const resp = await fetch(`/api/series?city=${encodeURIComponent(city)}&minutes=${minutes}&bucket=${bucket}`);
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        data = await resp.json();
        if(!Array.isArray(data.points) || data.points.length===0){
          renderBucketLatest(null);
          summaryEl.textContent = 'No points';
          log('No data returned.');
          if(chart) chart.destroy();
          return;
        }
        const labels = data.points.map(p=>new Date(p.timestamp).toLocaleTimeString());
        const temps = data.points.map(p=>p.avg_temp_c);
        const icons = data.points.map(p=>p.icon_url);
        const iconImages = icons.map(src=>{ if(!src) return null; const img = new Image(); img.src = src; return img; });
        if(chart) chart.destroy();
        chart = new Chart(q('#chart'), {
          type:'line',
          data:{ labels, datasets:[{ 
            label:`${data.city} Â°C`, 
            data:temps, 
            borderColor:'var(--accent)', 
            backgroundColor:'rgba(77,171,247,.15)', 
            pointRadius:6, 
            pointHoverRadius:8, 
            tension:.25, 
            fill:true,
            pointStyle:(ctx)=> iconImages[ctx.dataIndex] || 'circle'
          }]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            interaction:{ mode:'nearest', intersect:false },
            plugins:{ legend:{ display:true }, tooltip:{ callbacks:{ label:(ctx)=>`${ctx.parsed.y.toFixed(2)} Â°C` } } },
            scales:{ y:{ title:{ display:true, text:'Temp (Â°C)' }, grid:{ color:'rgba(255,255,255,.06)' } }, x:{ grid:{ display:false } } }
          }
        });
        renderBucketLatest(data.points[data.points.length-1]);
        summaryEl.textContent = `${data.points.length} pts â€¢ bucket ${data.bucket_minutes}m â€¢ window ${data.window_minutes}m`;
        log('Loaded successfully.');
      } catch(err){
        log('Error: '+ err.message);
      }
    }

    function scheduleAuto(){
      clearTimeout(autoTimer);
      if(!q('#auto').checked) return;
      const secs = Number(q('#interval').value) || 60;
      autoTimer = setTimeout(()=>{ load().then(scheduleAuto); }, secs*1000);
    }

    q('#auto').addEventListener('change', scheduleAuto);
    q('#interval').addEventListener('change', scheduleAuto);
    q('#load').addEventListener('click', ()=>{ load(); fetchCurrent(); scheduleAuto(); });
    document.querySelectorAll('input[name="view"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const isDaily = currentView()==='daily';
        q('#daysWrap').style.display = isDaily ? 'flex' : 'none';
        q('#minutes').parentElement.style.display = isDaily ? 'none' : 'flex';
        q('#bucket').parentElement.style.display = isDaily ? 'none' : 'flex';
        load();
      });
    });
    q('#export').addEventListener('click', async ()=>{
      const city = q('#city').value.trim();
      try {
        const resp = await fetch(`/api/series?city=${encodeURIComponent(city)}&minutes=${q('#minutes').value}&bucket=${q('#bucket').value}`);
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const data = await resp.json();
        downloadCsv(`${city}-series.csv`, toCsv(data));
        log('CSV exported.');
      } catch(e){ log('Export failed: '+ e.message); }
    });

    q('#toggleTheme').addEventListener('click', ()=>{
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === 'dark' ? 'light' : 'dark';
    });

    async function fetchCurrent(){
      const city = q('#city').value.trim();
      try {
        const resp = await fetch(`/api/current?city=${encodeURIComponent(city)}`);
        if(!resp.ok){ throw new Error('HTTP '+resp.status); }
        const data = await resp.json();
        renderCurrent(data);
        log('Current updated.');
      } catch(e){
        renderCurrent(null);
        log('Current fetch failed: '+e.message);
      }
    }

    load();
    fetchCurrent();
  </script>
</body>
</html>
